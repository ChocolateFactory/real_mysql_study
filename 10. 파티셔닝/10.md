# 10.1 파티션

### 파티션을 사용하는 이유

- 테이블의 데이터가 많아진다고 무조건 파티션을 써야하는 것이 아니다.
- 하나의 테이블이 너무 커서 인덱스의 크기가 메모리보다 큰 경우
- 주기적인 삭제작업이 필요한 경우

### 단일 INSERT와 단일 또는 범위 SELECT의 빠른 처리

인덱스의 크키가 메모리보다 큰 경우 테이블을 파티셔닝하여 워킹 셋(자주 사용하는 hot 데이터)의 크기를 줄이면 인덱스를 조각으로 만들어 메모리를 효과적으로 사용한다.

### 데이터의 물리 저장소 분리

MySQL에서 파티션을 통해 테이블 파일의 크기를 조절하거나 파티션별로 파일이 저장될 디스크를 다르게 지정하는 것이 가능하다. 하지만 MySQL에서 파티션단위로 순차 인덱스 생성하는 방법이 아직 허용되지 않는다. 

// 과연 최신 버전에서도 그런가?

### 로그 데이터의 효율적 관리

만료된 로그데이터를 백업하거나 삭제를 할때 일반 테이블에서는 큰 부하의 작업이지만 파티션을 사용하는 경우 파티션을 삭제하고 추가하는 방식으로 효과적으로 관리 가능

## MySQL의 파티션 내부 처리

#### INSERT

- 파티션 표현식을 이용해 레코드가 저장될 파티션을 찾는다.

#### UPDATE

- UPDATE 시에 조건에 파티션키 칼럼이 있다면 빠르게 해당 파티션을 찾아 UPDATE가 가능
- 조건에 파티션키 칼럼이 없는 경우 모든 파티션을 검색한다.
- 파티션키를 변경할 경우 새로운 파티션으로 데이터를 이동시킨다(무거운 작업)
- 그 외의 데이터 변경은 데이터만 변경하고 종료한다.

#### 파티션 테이블의 인덱스 스캔과 정렬

- 파티션 테이블에서 인덱스는 모두 로컬 인덱스(?)에 해당한다.
- 모든 인덱스는 파티션 단위로 생성된다.
- 파티션 테이블에서의 결과 데이터는 인덱스를 기준으로 자동 정렬된다. 하지만 실행계획에는 표시되지 않는다.
- 각 파티션에서 읽은 데이터를 우선순위 큐에 넣고 최종적으로 데이터를 읽을때 큐에서 데이터를 가져온다.

#### 파티션 프루닝

- 옵티마이저가 불필요한 파티션은 읽지 않는다. 이것을 파티션 프루닝이라고 한다.
- 파티션 프루닝을 EXPLAIN 하고 싶은 경우 EXPLAIN PARTITIONS 명령을 입력한다.

#### 파티션의 제약사항

- 최대 1024개의 파티션을 가질 수 있다.
- 스토어드 루틴, UDF, 사용자 변수를 파티션 함수나 식에 쓸 수 없다.
- 파티션 테이블에서는 외래키 사용 불가
- 파티션 테이블에서는 FULL TEXT SEARCH INDEX 생성 불가
- 공간 확장 기능(POINT, GEOMETRY(지도 관련 기능))은 파티션 테이블에서 사용 불가
- 파티션 함수에 모든 내장함수를 사용할 수 없다.
- 파티션 단위로 인덱스를 추가/변경이 불가능하다.

### 주의사항

- 파티셔닝은 검색 범위를 줄이기 위함인데 PK는 중복 레코드 체크 작업으로 범위를 좁힐 수 없다.
- 파티션키로 유니크 인데스(PK포함)을 사용하면 모든 유니크 인덱스나 모든 칼럼을 파티션키로 사용해야한다.
- 파티션을 사용하면 open_files_limit을 상향해주는 것을 고려해야한다. 파티셔닝을 하면 테이블이 작은 테이블단위로 쪼개지지 떄문이다.

#### 파티션 테이블과 잠금

- 파티션 테이블에 쿼리가 실행되면 테이블에 잠금을 걸고 쿼리 최적화를 수행한다.
- 파티션 프루닝을 쿼리 최적화 단계에서 실행되므로 모든 파티션을 열고 파티션 잠금을 걸어야한다.
- 이로 인해서 파티션 테이블이 과도하게 많은 경우 쿼리가 느려질 수 있다.



### MySQL 파티션의 종류

## 레인지 파티션

#### 용도

- 날짜기반으로 누적되는 데이터에서 기간 단위로 분석하고 삭제해야할떄
- 범위기반으로 여러 파티션에 데이터를 나눌때
- 파티션 키 위주로 작업이 수행될 때

#### 주의사항

- 레인지 파티션에서 NULL은 가장 작은 값으로 간주된다.
- YEAR(), TO_DAYS() 함수로 파티션을 한 경우가 아니면 파티션 프루닝이 제대로 동작하지 않을 수 있다.

## 리스트 파티션

### 용도

- 파티션 값이 코드나 카테고리 값과 같이 고정적일때
- 키값이 연속되지 않고 정렬 순서와 관계없이 파티션 해야할떄
- 파티션 키 값을 기준으로 건수가 균일하고 파티션키를 검색조건으로 사용할때

###  주의사항

- 명시되지 않은 나머지 값을 저장할 파티션을 정의할 수 없다.
- NULL값용 파티션 생성 불가능

## 해시 파티션

### 용도

- 레인지 파티션이나 리스트 파티션으로 데이터를 균등하게 나누기 힘든 경우
- 테이블의 모든 레코드가 비슷한 사용빈도이면서 크기가 클때

#### 주의사항

- 특정 파티션만 DROP하는게 불가능
- 새로운 파티션 추가는 모든 데이터 재배치를 의미한다.
- 해시 파티션의 특성을 잘 이해해야한다.

## 키 파티션

해시 파티션에서 해시를 MySQL이 지정한 MD5만 사용한다.